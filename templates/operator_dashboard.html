<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASİS - Operator Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        body {
            background-image: url("{{ url_for('static', filename='bg.jpg') }}");
            background-size: cover;
            background-position: center;
            background-attachment: fixed; 
            min-height: 100vh;
        }
        .content-container {
            background-color: rgba(255, 255, 255, 0.95); 
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }
        .table-responsive { border-radius: 8px; overflow: hidden; }
        .table thead { background-color: #0d6efd; color: white; }
        .form-inline-delete { display: inline-block; margin: 0; padding: 0; }
        .clickable-row { cursor: pointer; transition: background-color 0.2s ease-in-out; }
        .clickable-row:hover { background-color: #f0f8ff; }
        .clickable-row[aria-expanded="true"] { background-color: #e6f2ff; border-bottom: 2px solid #0d6efd; }
        .expense-details-row td { background-color: #fafafa; padding: 0 !important; border-top: none !important; overflow: hidden; }
        .expense-details-container { padding: 15px; background-color: #fdfdfd; box-shadow: inset 0 4px 8px rgba(0,0,0,0.05); }
        .collapsing { transition: height 0.25s ease-out !important; }
        
        /* Tarixçə cədvəli üçün kiçik şrift */
        .table-sm th, .table-sm td {
            font-size: 0.85rem;
            padding: 0.4rem;
        }
    </style>
</head>
<body>
    {% include 'operator_navbar.html' %}
    
    <div class="container-fluid mt-4 content-container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category or 'info' }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="row">
            <div class="col-12 mb-4">
                <h2 class="text-primary"><i class="fas fa-tasks"></i> Operator Paneli</h2>
                <div class="d-flex flex-wrap gap-2">
                    <a href="{{ url_for('admin_drivers') }}" class="btn btn-success"><i class="fas fa-user-plus"></i> Sürücü İdarəetmə</a>
                    <a href="{{ url_for('admin_cars') }}" class="btn btn-info text-white"><i class="fas fa-plus"></i> Avtomobil İdarəetmə</a>
                    <a href="{{ url_for('admin_assistants') }}" class="btn btn-secondary"><i class="fas fa-user-friends"></i> Köməkçi İdarəetmə</a>
                    <a href="{{ url_for('admin_planners') }}" class="btn btn-dark"><i class="fas fa-user-tie"></i> Planlamaçı İdarəetmə</a>
                </div>
            </div>

            <div class="col-12">
                <div class="table-responsive">
                    <table class="table table-hover table-striped align-middle">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Avtomobil Nömrəsi</th>
                                <th>Marka / Model</th>
                                <th>Kategoriya</th>
                                <th>Sürücü Adı</th>
                                <th>Köməkçi adı</th>
                                <th>Planlamaçı</th>
                                <th class="text-end text-warning">Ümumi Xərc (AZN)</th>
                                <th class="text-warning">Son Xərci Qeyd Edən</th>
                                <th>Qeydlər</th>
                                <th class="text-center">Əməliyyatlar</th> 
                            </tr>
                        </thead>
                        <tbody>
                            {% for car in cars %}
                            <tr class="clickable-row" data-bs-toggle="collapse" data-bs-target="#details-{{ car.id }}" aria-expanded="false" aria-controls="details-{{ car.id }}">
                                <td>{{ loop.index }} <i class="fas fa-chevron-down fa-xs text-muted ms-1"></i></td>
                                <td><span class="badge bg-dark">{{ car.car_number }}</span></td>
                                <td>{{ car.brand_model or '-' }}</td>
                                <td>{{ car.category or '-' }}</td>
                                <td>
                                    {% if car.driver_name == "TƏYİN OLUNMAYIB" %}
                                        <span class="badge bg-danger">{{ car.driver_name }}</span>
                                    {% else %}
                                        {{ car.driver_name }}
                                    {% endif %}
                                </td>
                                <td>{{ car.assistant_name or '-' }}</td>
                                <td>{{ car.planner_name or '-' }}</td>
                                <td class="text-end text-danger fw-bold">
                                    {{ "%.2f"|format(car.total_expense) if car.total_expense > 0 else "0.00" }}
                                </td>
                                <td>{{ car.entered_by|capitalize }}</td>
                                <td>{{ car.notes }}</td>
                                <td class="text-center">
                                    <button 
                                        class="btn btn-sm btn-outline-success me-1"
                                        data-bs-toggle="modal" data-bs-target="#expenseModal"
                                        data-bs-car-id="{{ car.id }}" data-bs-car-number="{{ car.car_number }}"
                                        onclick="event.stopPropagation();" title="Xərc əlavə et">
                                        <i class="fas fa-gas-pump"></i>
                                    </button>

                                    <button 
                                        class="btn btn-sm btn-secondary me-1"
                                        data-bs-toggle="modal" data-bs-target="#carMetaModal"
                                        data-bs-car-id="{{ car.id }}" data-bs-car-number="{{ car.car_number }}"
                                        data-bs-brand="{{ car.brand_raw or '' }}"
                                        data-bs-model-name="{{ car.model_name_raw or '' }}"
                                        data-bs-category="{{ car.category or '' }}"
                                        data-bs-driver-id="{{ car.driver_id | default('', true) }}"
                                        data-bs-assistant-id="{{ car.assistant_id or '' }}"
                                        data-bs-planner-id="{{ car.planner_id or '' }}"
                                        data-bs-notes="{{ car.notes or '' }}"
                                        onclick="event.stopPropagation();" title="Avtomobil məlumatları">
                                        <i class="fas fa-sliders"></i>
                                    </button>

                                    {% if car.has_expenses %}
                                        <button type="button" class="btn btn-sm btn-danger" disabled
                                            onclick="event.stopPropagation();" 
                                            title="Xərcləri olan avtomobil silinə bilməz">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    {% else %}
                                        <form method="POST" action="{{ url_for('delete_car', id=car.id) }}" class="form-inline-delete" 
                                              onsubmit="return confirm('Bu avtomobili silməyə əminsiniz?');">
                                            <button type="submit" class="btn btn-sm btn-danger" 
                                                    onclick="event.stopPropagation();" 
                                                    title="Sil">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </form>
                                    {% endif %}
                                </td>
                            </tr>
                            
                            <tr class="collapse expense-details-row" id="details-{{ car.id }}">
                                <td colspan="11"> <div class="expense-details-container">
                                        <h5 class="text-primary"><i class="fas fa-history"></i> {{ car.car_number }} üçün Xərc Tarixçəsi</h5>
                                        {% if car.expenses %}
                                            <table class="table table-sm table-bordered">
                                                <thead class="bg-light">
                                                    <tr>
                                                        <th>Tarix / Saat</th>
                                                        <th>Növ</th>
                                                        <th class="text-end">Məbləğ (AZN)</th>
                                                        <th class="text-end">Litr</th>
                                                        <th>Açıqlama</th>
                                                        <th>Sürücü (Xərc anında)</th>
                                                        <th>Köməkçi (Xərc anında)</th>
                                                        <th>Planlamaçı (Xərc anında)</th>
                                                        <th>Qeyd Etdi</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for expense in car.expenses %}
                                                    <tr>
                                                        <td>{{ expense.timestamp_str }}</td>
                                                        <td>
                                                            {% if expense.type == 'Yanacaq' %}<span class="badge bg-success">Yanacaq</span>
                                                            {% elif expense.type == 'Təmir' %}<span class="badge bg-warning text-dark">Təmir</span>
                                                            {% elif expense.type == 'Cərimə' %}<span class="badge bg-danger">Cərimə</span>
                                                            {% elif expense.type == 'Avtoyuma' %}<span class="badge bg-info">Avtoyuma</span>
                                                            {% elif expense.type == 'Yemək' %}<span class="badge bg-primary">Yemək</span>
                                                            {% else %}<span class="badge bg-secondary">{{ expense.type }}</span>{% endif %}
                                                        </td>
                                                        <td class="text-end text-danger fw-bold">{{ "%.2f"|format(expense.amount) }}</td>
                                                        <td class="text-end">{{ expense.litr if expense.litr > 0 else '-' }}</td>
                                                        <td>{{ expense.description }}</td>
                                                        <td>{{ expense.driver_name }}</td>
                                                        <td>{{ expense.assistant_name }}</td>
                                                        <td>{{ expense.planner_name }}</td>
                                                        <td>{{ expense.entered_by|capitalize }}</td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        {% else %}
                                            <div class="alert alert-secondary text-center">
                                                Bu avtomobil üçün heç bir xərc qeydə alınmayıb.
                                            </div>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="expenseModal" tabindex="-1" aria-labelledby="expenseModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="expenseModalLabel"><i class="fas fa-plus-circle"></i> Xərc Qeydiyyatı</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="expenseForm" method="POST" action="{{ url_for('add_expense') }}">
                        <p class="text-muted">Seçilmiş Avtomobil: <strong id="modalCarNumber"></strong></p>
                        
                        <div class="mb-3">
                            <label for="expenseType" class="form-label">Xərc Növü</label>
                            <select class="form-select" id="expenseType" name="expense_type" required>
                                <option value="" disabled selected>-- Növü seçin --</option>
                                <option value="Yanacaq">Yanacaq</option>
                                <option value="Təmir">Təmir</option>
                                <option value="Cərimə">Cərimə</option>
                                <option value="Avtoyuma">Avtoyuma</option>
                                <option value="Yemək">Yemək</option>
                                <option value="Digər">Digər</option>
                            </select>
                        </div>
                        
                        <div class="mb-3" id="fuelTypeGroup" style="display: none;">
                            <label for="fuelSubType" class="form-label">Yanacaq Növü</label>
                            <select class="form-select" id="fuelSubType" name="fuel_subtype">
                                <option value="Dizel">Dizel</option>
                                <option value="AI-92">AI-92</option>
                                <option value="AI-95">AI-95</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="amount" class="form-label" id="amountLabel">Məbləğ (AZN)</label>
                            <input type="number" step="0.01" class="form-control" id="amount" name="amount" required>
                        </div>
                        
                        <div class="mb-3" id="litrGroup" style="display: none;">
                            <label class="form-label">Litr</label>
                            <input type="number" step="0.01" class="form-control" id="litr" name="litr">
                        </div>
                        
                        <div class="mb-3">
                            <label for="description" class="form-label">Açıqlama / Qeyd</label>
                            <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
                        </div>
                        <input type="hidden" name="car_id" id="modalCarId" value="">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" data-bs-dismiss="modal">Ləğv Et</button>
                    <button type="submit" form="expenseForm" class="btn btn-success">Yadda Saxla</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="carMetaModal" tabindex="-1" aria-labelledby="carMetaModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-secondary text-white">
                    <h5 class="modal-title" id="carMetaModalLabel"><i class="fas fa-sliders"></i> Avtomobil Məlumatları</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="carMetaForm" method="POST" action="{{ url_for('update_car_meta') }}">
                        <p class="text-muted">Avtomobil: <strong id="modalMetaCarNumber"></strong></p>
                        <input type="hidden" name="car_id" id="modalMetaCarId" value="">

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Marka</label>
                                <input type="text" class="form-control" name="brand" id="metaBrand">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Model</label>
                                <input type="text" class="form-control" name="model_name" id="metaModelName">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Kategoriya</label>
                                <input type="text" class="form-control" name="category" id="metaCategory">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Sürücü</label>
                                <select class="form-select" name="driver_id" id="metaDriver">
                                    <option value="">Seçilməyib (Boş)</option>
                                    {% for driver in drivers %}
                                        <option value="{{ driver.id }}">{{ driver.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Köməkçi</label>
                                <select class="form-select" name="assistant_id" id="metaAssistant">
                                    <option value="">Seçilməyib</option>
                                    {% for a in assistants %}
                                        <option value="{{ a.id }}">{{ a.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Planlamaçı</label>
                                <select class="form-select" name="planner_id" id="metaPlanner">
                                    <option value="">Seçilməyib</option>
                                    {% for p in planners %}
                                        <option value="{{ p.id }}">{{ p.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Qeydlər</label>
                                <textarea class="form-control" rows="3" name="notes" id="metaNotes"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" data-bs-dismiss="modal">Ləğv Et</button>
                    <button type="submit" form="carMetaForm" class="btn btn-secondary">Yadda Saxla</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            const expenseModal = document.getElementById('expenseModal');
            const expenseTypeSelect = document.getElementById('expenseType');
            const fuelTypeGroup = document.getElementById('fuelTypeGroup');
            const fuelSubTypeSelect = document.getElementById('fuelSubType');
            const litrGroup = document.getElementById('litrGroup');

            // --- YENİ XƏRC NÖVÜ MƏNTİQİ ---
            if (expenseTypeSelect) {
                expenseTypeSelect.addEventListener('change', function() {
                    const selectedType = this.value;
                    
                    if (selectedType === 'Yanacaq') {
                        // Yanacaq seçilibsə, həm yanacaq növünü, həm də litri göstər
                        fuelTypeGroup.style.display = 'block';
                        fuelSubTypeSelect.setAttribute('required', 'required'); // Yanacaq növü məcburidir
                        
                        litrGroup.style.display = 'block';
                        // litrGroup.querySelector('#litr').setAttribute('required', 'required'); // Litr məcburi deyil
                    } else {
                        // Başqa bir şey seçilibsə, hər ikisini gizlət
                        fuelTypeGroup.style.display = 'none';
                        fuelSubTypeSelect.removeAttribute('required'); // Artıq məcburi deyil
                        
                        litrGroup.style.display = 'none';
                        // litrGroup.querySelector('#litr').removeAttribute('required');
                    }
                });
            }

            // Xərc modalı açılarkən məlumatları ötür və formu sıfırla
            if (expenseModal) {
                expenseModal.addEventListener('show.bs.modal', function (event) {
                    event.stopPropagation(); 
                    const button = event.relatedTarget; 
                    const carId = button.getAttribute('data-bs-car-id');
                    const carNumber = button.getAttribute('data-bs-car-number');
                    expenseModal.querySelector('#modalCarNumber').textContent = carNumber;
                    expenseModal.querySelector('#modalCarId').value = carId;

                    // Formu sıfırla (əvvəlki seçimlər qalmasın)
                    document.getElementById('expenseForm').reset();
                    fuelTypeGroup.style.display = 'none';
                    fuelSubTypeSelect.removeAttribute('required');
                    litrGroup.style.display = 'none';
                });
            }
            
            // KÖHNƏ LİTR MƏNTİQİ (RADIO DÜYMƏLƏR) ARTIQ LAZIM DEYİL

            // Avtomobil meta modalı
            const carMetaModal = document.getElementById('carMetaModal');
            if (carMetaModal) {
                carMetaModal.addEventListener('show.bs.modal', function (event) {
                    event.stopPropagation();
                    const button = event.relatedTarget;
                    const carId = button.getAttribute('data-bs-car-id');
                    const carNumber = button.getAttribute('data-bs-car-number');

                    const brand = button.getAttribute('data-bs-brand') || '';
                    const modelName = button.getAttribute('data-bs-model-name') || '';
                    const category = button.getAttribute('data-bs-category') || '';
                    
                    const driverId = button.getAttribute('data-bs-driver-id') || ''; 
                    const assistantId = button.getAttribute('data-bs-assistant-id') || '';
                    const plannerId = button.getAttribute('data-bs-planner-id') || '';
                    
                    const notes = button.getAttribute('data-bs-notes') || '';

                    carMetaModal.querySelector('#modalMetaCarNumber').textContent = carNumber;
                    carMetaModal.querySelector('#modalMetaCarId').value = carId;

                    carMetaModal.querySelector('#metaBrand').value = brand;
                    carMetaModal.querySelector('#metaModelName').value = modelName;
                    carMetaModal.querySelector('#metaCategory').value = category; // Düzəliş: carMetaMetaModal -> carMetaModal

                    carMetaModal.querySelector('#metaDriver').value = driverId; 
                    carMetaModal.querySelector('#metaAssistant').value = assistantId;
                    carMetaModal.querySelector('#metaPlanner').value = plannerId;
                    
                    carMetaModal.querySelector('#metaNotes').value = notes;
                });
            }

            // Aşağı-açılan xərc tarixçəsi icon animasiyası
            document.querySelectorAll('.collapse').forEach(function(collapseEl) {
                collapseEl.addEventListener('show.bs.collapse', function () {
                    const triggerRow = document.querySelector('[data-bs-target="#' + collapseEl.id + '"]');
                    if(triggerRow) {
                        const icon = triggerRow.querySelector('.fa-chevron-down');
                        if(icon) icon.style.transform = 'rotate(180deg)';
                    }
                });
                collapseEl.addEventListener('hide.bs.collapse', function () {
                    const triggerRow = document.querySelector('[data-bs-target="#' + collapseEl.id + '"]');
                    if(triggerRow) {
                        const icon = triggerRow.querySelector('.fa-chevron-down');
                        if(icon) icon.style.transform = 'rotate(0deg)';
                    }
                });
            });
        });
    </script>
</body>
</html>